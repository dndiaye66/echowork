generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum ProfileType {
  CLIENT
  EMPLOYEE
  SUPPLIER
  OTHER
}

enum CompanySize {
  TPE
  PME
  GRANDE
}

enum ReviewContext {
  CLIENT
  EMPLOYEE
  SUPPLIER
  OTHER
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SubscriptionPlan {
  FREE
  PRO
  PREMIUM
}

enum AdvertisementType {
  BANNER
  SPONSORED
}

enum AdvertisementStatus {
  ACTIVE
  PAUSED
  ENDED
}

model User {
  id             Int           @id @default(autoincrement())
  username       String        @unique
  email          String        @unique
  phone          String?
  password       String
  role           UserRole      @default(USER)
  isVerified     Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  reviews        Review[]
  profile        UserProfile?
  claimedCompanies Company[]

  @@index([username])
  @@index([email])
}

model UserProfile {
  id          Int         @id @default(autoincrement())
  userId      Int         @unique
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName    String?
  profileType ProfileType @default(CLIENT)
  trustScore  Float       @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([userId])
  @@index([trustScore])
}

model Category {
  id        Int                @id @default(autoincrement())
  name      String
  slug      String             @unique
  parentId  Int?
  parent    Category?          @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[]         @relation("CategoryHierarchy")
  companies Company[]
  keywords  CategoryKeyword[]

  @@index([slug])
  @@index([parentId])
}

model CategoryKeyword {
  id         Int      @id @default(autoincrement())
  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  keyword    String
  createdAt  DateTime @default(now())

  @@index([categoryId])
  @@index([keyword])
}

model Company {
  id             Int                @id @default(autoincrement())
  name           String
  slug           String             @unique
  description    String?
  imageUrl       String?
  ville          String?            // City (deprecated, use CompanyLocation)
  adresse        String?            // Address (deprecated, use CompanyLocation)
  tel            String?            // Telephone
  activite       String?            // Activity/Business type
  ninea          String?            @unique // NINEA number (Senegal business ID)
  rccm           String?            // RCCM number (Commercial registry)
  size           CompanySize?       // Company size
  isVerified     Boolean            @default(false)
  claimedByUserId Int?
  claimedBy      User?              @relation(fields: [claimedByUserId], references: [id], onDelete: SetNull)
  categoryId     Int
  category       Category           @relation(fields: [categoryId], references: [id])
  reviews        Review[]
  jobOffers      JobOffer[]
  advertisements Advertisement[]
  locations      CompanyLocation[]
  scores         CompanyScore?
  subscription   Subscription?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@index([slug])
  @@index([categoryId])
  @@index([name])
  @@index([ninea])
  @@index([isVerified])
  @@index([claimedByUserId])
}

model CompanyLocation {
  id         Int      @id @default(autoincrement())
  companyId  Int
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  region     String?
  department String?
  city       String?
  address    String?
  lat        Float?
  lng        Float?
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([companyId])
  @@index([region])
  @@index([city])
}

model Review {
  id        Int           @id @default(autoincrement())
  rating    Int
  comment   String
  context   ReviewContext @default(CLIENT)
  status    ReviewStatus  @default(PENDING)
  userId    Int
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId Int
  company   Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  upvotes   Int           @default(0)
  downvotes Int           @default(0)
  scores    ReviewScore[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([companyId])
  @@index([userId])
  @@index([rating])
  @@index([status])
  @@index([context])
}

model RatingCriteria {
  id          Int           @id @default(autoincrement())
  name        String
  description String?
  weight      Float         @default(1.0)
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  scores      ReviewScore[]

  @@index([isActive])
}

model ReviewScore {
  id         Int            @id @default(autoincrement())
  reviewId   Int
  review     Review         @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  criteriaId Int
  criteria   RatingCriteria @relation(fields: [criteriaId], references: [id], onDelete: Cascade)
  score      Int            // 1-5
  createdAt  DateTime       @default(now())

  @@unique([reviewId, criteriaId])
  @@index([reviewId])
  @@index([criteriaId])
  @@index([score])
}

model JobOffer {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  salary      String?
  location    String?
  companyId   Int
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([isActive])
}

model CompanyScore {
  id           Int      @id @default(autoincrement())
  companyId    Int      @unique
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  globalScore  Float    @default(0)
  trustIndex   Float    @default(0)
  totalReviews Int      @default(0)
  lastUpdated  DateTime @updatedAt
  createdAt    DateTime @default(now())

  @@index([companyId])
  @@index([globalScore])
  @@index([trustIndex])
}

model Subscription {
  id        Int              @id @default(autoincrement())
  companyId Int              @unique
  company   Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan      SubscriptionPlan @default(FREE)
  startDate DateTime         @default(now())
  endDate   DateTime?
  isActive  Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([companyId])
  @@index([plan])
  @@index([isActive])
  @@index([endDate])
}

model Advertisement {
  id        Int                  @id @default(autoincrement())
  title     String
  content   String
  imageUrl  String?
  type      AdvertisementType    @default(BANNER)
  status    AdvertisementStatus  @default(ACTIVE)
  companyId Int?
  company   Company?             @relation(fields: [companyId], references: [id], onDelete: SetNull)
  startDate DateTime
  endDate   DateTime
  isActive  Boolean              @default(true)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  @@index([companyId])
  @@index([isActive])
  @@index([status])
  @@index([type])
  @@index([startDate, endDate])
}
